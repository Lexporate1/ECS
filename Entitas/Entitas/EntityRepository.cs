using ToolKit;
using System.Collections.Generic;
using System;

namespace Entitas {
    public class EntityRepository {
        readonly OrderedSet<Entity> _entities = new OrderedSet<Entity>();
        readonly Dictionary<IEntityMatcher, EntityCollection> _collections = new Dictionary<IEntityMatcher, EntityCollection>();
        readonly Dictionary<Type, List<EntityCollection>> _collectionsForType = new Dictionary<Type, List<EntityCollection>>();
        readonly List<EntityCollection> _collectionList = new List<EntityCollection>();
        ulong _creationIndex;
        Entity[] _entitiesCache;

        public EntityRepository() {
            _creationIndex = 0;
        }

        public EntityRepository(ulong startCreationIndex) {
            _creationIndex = startCreationIndex;
        }

        public Entity CreateEntity() {
            return CreateEntity(null);
        }

        public Entity CreateEntity(IComponent[] components) {
            var entity = new Entity(_creationIndex++);
            _entities.Add(entity);
            _entitiesCache = null;

            if (components != null) {
                foreach (var component in components)
                    entity.AddComponent(component);

                foreach (var collection in _collectionList)
                    collection.AddEntityIfMatching(entity);
            }

            entity.OnComponentAdded += onComponentAdded;
            entity.OnComponentRemoved += onComponentRemoved;
            entity.OnComponentReplaced += onComponentReplaced;

            return entity;
        }

        public void DestroyEntity(Entity entity) {
            entity.OnComponentAdded -= onComponentAdded;
            entity.OnComponentRemoved -= onComponentRemoved;
            entity.OnComponentReplaced -= onComponentReplaced;
            entity.RemoveAllComponents();
            removeFromAllCollections(entity);
            _entities.Remove(entity);
            _entitiesCache = null;
        }

        public void DestroyAllEntities() {
            var entities = GetEntities();
            foreach (var e in entities)
                DestroyEntity(e);
        }

        public bool HasEntity(Entity entity) {
            return _entities.Contains(entity);
        }

        public Entity[] GetEntities() {
            if (_entitiesCache == null)
                _entitiesCache = _entities.ToArray();

            return _entitiesCache;
        }

        public EntityCollection GetCollection(IEntityMatcher matcher) {
            if (!_collections.ContainsKey(matcher)) {
                var collection = new EntityCollection(matcher);
                foreach (var e in GetEntities())
                    collection.AddEntityIfMatching(e);
                _collections.Add(matcher, collection);
                _collectionList.Add(collection);

                foreach (var type in matcher.types) {
                    if (!_collectionsForType.ContainsKey(type))
                        _collectionsForType.Add(type, new List<EntityCollection>());

                    _collectionsForType[type].Add(collection);
                }
            }

            return _collections[matcher];
        }

        void onComponentAdded(Entity entity, IComponent component) {
            var type = component.GetType();
            if (_collectionsForType.ContainsKey(type)) {
                var collections = _collectionsForType[type];
                foreach (var collection in collections)
                    collection.AddEntityIfMatching(entity);
            }
        }

        void onComponentRemoved(Entity entity, IComponent component) {
            var type = component.GetType();
            if (_collectionsForType.ContainsKey(type)) {
                var collections = _collectionsForType[type];
                foreach (var collection in collections)
                    collection.RemoveEntity(entity);
            }
        }

        void onComponentReplaced(Entity entity, IComponent component) {
            var type = component.GetType();
            if (_collectionsForType.ContainsKey(type)) {
                var collections = _collectionsForType[type];
                foreach (var collection in collections)
                    collection.ReplaceEntity(entity);
            }
        }

        void removeFromAllCollections(Entity entity) {
            foreach (var collection in _collectionList)
                collection.RemoveEntity(entity);
        }
    }
}

